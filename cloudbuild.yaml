# ============================================================================
# Cloud Build Configuration for Solar Facades

## ğŸ“‹ Resumen# ============================================================================

# This file defines the CI/CD pipeline that:

Este documento explica cÃ³mo configurar el despliegue automÃ¡tico de tu aplicaciÃ³n Solar Facades cada vez que hagas push a la rama `main` en GitHub.# 1. Builds Docker images for backend, ingestor, and alert-monitor

# 2. Pushes images to Artifact Registry

## âœ… Estado Actual# 3. Deploys to GKE cluster

# ============================================================================

- âœ… `cloudbuild.yaml` configurado y actualizado con la IP correcta del backend

- âœ… Cloud Build API habilitadaoptions:

- âœ… Permisos configurados para Cloud Build  machineType: 'N1_HIGHCPU_8'

  logging: CLOUD_LOGGING_ONLY

## ğŸ”§ ConfiguraciÃ³n del Trigger (MANUAL)

substitutions:

Cloud Build necesita conectarse a tu repositorio de GitHub. Esto se debe hacer desde la consola web:  _REGION: us-central1

  _CLUSTER_NAME: solar-facades-cluster

### Paso 1: Conectar GitHub con Cloud Build  _NAMESPACE: solar-facades-prod

  _ARTIFACT_REGISTRY: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/solar-facades

1. Ve a: https://console.cloud.google.com/cloud-build/triggers?project=bicpv-477720

steps:

2. Haz clic en **"CREATE TRIGGER"** (Crear Activador)  # ============================================================================

  # Step 1: Build Backend Image

3. Selecciona **"Connect Repository"** (Conectar Repositorio)  # ============================================================================

  - name: 'gcr.io/cloud-builders/docker'

4. Selecciona **GitHub** como fuente    id: 'build-backend'

    args:

5. Autentica con tu cuenta de GitHub (Alkran93)      - 'build'

      - '-t'

6. Selecciona el repositorio: **Project-BICPV**      - '${_ARTIFACT_REGISTRY}/backend:${SHORT_SHA}'

      - '-t'

7. Haz clic en **"Connect"** (Conectar)      - '${_ARTIFACT_REGISTRY}/backend:latest'

      - '-f'

### Paso 2: Crear el Trigger      - 'backend/Dockerfile.prod'

      - './backend'

Una vez conectado el repositorio, configura el trigger:

  # ============================================================================

**ConfiguraciÃ³n del Trigger:**  # Step 2: Build Ingestor Image

- **Name:** `solar-facades-deploy`  # ============================================================================

- **Event:** Push to a branch  - name: 'gcr.io/cloud-builders/docker'

- **Source:**    id: 'build-ingestor'

  - Repository: `Alkran93/Project-BICPV`    args:

  - Branch: `^main$` (regex pattern)      - 'build'

- **Configuration:**      - '-t'

  - Type: Cloud Build configuration file      - '${_ARTIFACT_REGISTRY}/ingestor:${SHORT_SHA}'

  - Location: `/cloudbuild.yaml`      - '-t'

- **Advanced (opcional):**      - '${_ARTIFACT_REGISTRY}/ingestor:latest'

  - Region: `us-central1`      - '-f'

  - Service account: Default      - 'ingestor/Dockerfile.prod'

      - './ingestor'

Haz clic en **"CREATE"** (Crear)

  # ============================================================================

## ğŸ¯ Â¿CÃ³mo Funciona?  # Step 3: Build Alert Monitor Image

  # ============================================================================

DespuÃ©s de configurar el trigger:  - name: 'gcr.io/cloud-builders/docker'

    id: 'build-alert-monitor'

1. **Haces cambios** en tu cÃ³digo local    args:

2. **Commit y push** a la rama `main`:      - 'build'

   ```bash      - '-t'

   git add .      - '${_ARTIFACT_REGISTRY}/alert-monitor:${SHORT_SHA}'

   git commit -m "Tu mensaje de commit"      - '-t'

   git push origin main      - '${_ARTIFACT_REGISTRY}/alert-monitor:latest'

   ```      - '-f'

3. **AutomÃ¡ticamente** Cloud Build:      - 'Dockerfile.alert-monitor'

   - ğŸ”¨ Construye las 4 imÃ¡genes Docker (backend, frontend, ingestor, alert-monitor)      - '.'

   - ğŸ“¤ Las sube a Artifact Registry

   - ğŸš€ Actualiza los deployments en GKE  # ============================================================================

   - â³ Espera a que los rollouts se completen  # Step 4: Build Frontend Image

   - âœ… Verifica que los pods estÃ©n funcionando  # ============================================================================

  - name: 'gcr.io/cloud-builders/docker'

**Tiempo estimado:** 10-15 minutos por despliegue completo    id: 'build-frontend'

    args:

## ğŸ“Š Monitorear Despliegues      - 'build'

      - '-t'

### Ver el progreso de un build:      - '${_ARTIFACT_REGISTRY}/frontend:${SHORT_SHA}'

https://console.cloud.google.com/cloud-build/builds?project=bicpv-477720      - '-t'

      - '${_ARTIFACT_REGISTRY}/frontend:latest'

### Desde la terminal:      - '--build-arg'

```bash      - 'VITE_API_URL=http://34.135.241.88:8000'

# Ver los Ãºltimos builds      - '-f'

gcloud builds list --limit=5 --project=bicpv-477720      - 'frontend/Dockerfile.prod'

      - './frontend'

# Ver logs de un build especÃ­fico

gcloud builds log <BUILD_ID> --project=bicpv-477720  # ============================================================================

  # Step 5: Push Backend Image

# Ver builds en tiempo real  # ============================================================================

gcloud builds list --ongoing --project=bicpv-477720  - name: 'gcr.io/cloud-builders/docker'

```    id: 'push-backend'

    args:

## ğŸ› ï¸ Despliegue Manual (sin push)      - 'push'

      - '--all-tags'

Si necesitas desplegar manualmente sin hacer push:      - '${_ARTIFACT_REGISTRY}/backend'

    waitFor: ['build-backend']

```bash

# Desde el directorio raÃ­z del proyecto  # ============================================================================

gcloud builds submit --config=cloudbuild.yaml --project=bicpv-477720  # Step 6: Push Ingestor Image

```  # ============================================================================

  - name: 'gcr.io/cloud-builders/docker'

## ğŸ”„ Workflow Completo    id: 'push-ingestor'

    args:

```      - 'push'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      - '--all-tags'

â”‚  git push main  â”‚      - '${_ARTIFACT_REGISTRY}/ingestor'

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    waitFor: ['build-ingestor']

         â”‚

         â–¼  # ============================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  # Step 7: Push Alert Monitor Image

â”‚  Cloud Build Trigger    â”‚  # ============================================================================

â”‚  (AutomÃ¡tico)           â”‚  - name: 'gcr.io/cloud-builders/docker'

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    id: 'push-alert-monitor'

         â”‚    args:

         â–¼      - 'push'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      - '--all-tags'

â”‚  Build Docker Images    â”‚      - '${_ARTIFACT_REGISTRY}/alert-monitor'

â”‚  - backend              â”‚    waitFor: ['build-alert-monitor']

â”‚  - frontend             â”‚

â”‚  - ingestor             â”‚  # ============================================================================

â”‚  - alert-monitor        â”‚  # Step 8: Push Frontend Image

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  # ============================================================================

         â”‚  - name: 'gcr.io/cloud-builders/docker'

         â–¼    id: 'push-frontend'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    args:

â”‚  Push to Artifact       â”‚      - 'push'

â”‚  Registry               â”‚      - '--all-tags'

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      - '${_ARTIFACT_REGISTRY}/frontend'

         â”‚    waitFor: ['build-frontend']

         â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  # ============================================================================

â”‚  Update GKE             â”‚  # Step 9: Get GKE Credentials

â”‚  Deployments            â”‚  # ============================================================================

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  - name: 'gcr.io/cloud-builders/gcloud'

         â”‚    id: 'get-credentials'

         â–¼    args:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      - 'container'

â”‚  Rollout & Verify       â”‚      - 'clusters'

â”‚  âœ… Pods Running        â”‚      - 'get-credentials'

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      - '${_CLUSTER_NAME}'

```      - '--region=${_REGION}'

    waitFor: ['-']

## ğŸ›ï¸ ConfiguraciÃ³n Avanzada (Opcional)

  # ============================================================================

### Variables de Entorno  # Step 10: Update Backend Deployment

  # ============================================================================

Puedes agregar variables en el trigger de Cloud Build:  - name: 'gcr.io/cloud-builders/kubectl'

    id: 'deploy-backend'

```yaml    args:

substitutions:      - 'set'

  _BACKEND_REPLICAS: "2"      - 'image'

  _FRONTEND_REPLICAS: "2"      - 'deployment/backend'

  _ENVIRONMENT: "production"      - 'backend=${_ARTIFACT_REGISTRY}/backend:${SHORT_SHA}'

```      - '-n'

      - '${_NAMESPACE}'

### Notificaciones    env:

      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'

Para recibir notificaciones de Slack/Email cuando falla un build:      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'

    waitFor: ['push-backend', 'get-credentials']

1. Ve a: https://console.cloud.google.com/cloud-build/settings/notifiers?project=bicpv-477720

2. Configura un notifier (Slack, Email, etc.)  # ============================================================================

  # Step 11: Update Ingestor Deployment

## ğŸ” Secretos y Seguridad  # ============================================================================

  - name: 'gcr.io/cloud-builders/kubectl'

Los secretos (contraseÃ±as, URLs) NO se incluyen en `cloudbuild.yaml`.    id: 'deploy-ingestor'

Ya estÃ¡n configurados en:    args:

- **Secret Manager:** ContraseÃ±as de DB, Redis      - 'set'

- **Kubernetes Secrets:** Dentro del cluster      - 'image'

      - 'deployment/ingestor'

## ğŸ“ Notas Importantes      - 'ingestor=${_ARTIFACT_REGISTRY}/ingestor:${SHORT_SHA}'

      - '-n'

1. **Primera vez:** DespuÃ©s de crear el trigger, haz un commit dummy para probar:      - '${_NAMESPACE}'

   ```bash    env:

   git commit --allow-empty -m "Test CI/CD pipeline"      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'

   git push origin main      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'

   ```    waitFor: ['push-ingestor', 'get-credentials']



2. **Frontend:** Ya estÃ¡ configurado para usar `http://34.135.241.88:8000` como backend  # ============================================================================

  # Step 12: Update Alert Monitor Deployment

3. **Dockerfiles:** Usa `Dockerfile.prod` en lugar de `Dockerfile` para todos los servicios  # ============================================================================

  - name: 'gcr.io/cloud-builders/kubectl'

4. **Costos:** Cloud Build tiene 120 minutos gratis por dÃ­a. Cada despliegue toma ~10-15 min.    id: 'deploy-alert-monitor'

    args:

## ğŸ†˜ Troubleshooting      - 'set'

      - 'image'

### Error: "Repository not found"      - 'deployment/alert-monitor'

- Verifica que conectaste el repo correcto en la consola de Cloud Build      - 'alert-monitor=${_ARTIFACT_REGISTRY}/alert-monitor:${SHORT_SHA}'

- AsegÃºrate de haber dado permisos de acceso a Cloud Build en GitHub      - '-n'

      - '${_NAMESPACE}'

### Error: "Permission denied to GKE"    env:

```bash      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'

# Volver a dar permisos      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'

PROJECT_NUMBER=$(gcloud projects describe bicpv-477720 --format='value(projectNumber)')    waitFor: ['push-alert-monitor', 'get-credentials']

gcloud projects add-iam-policy-binding bicpv-477720 \

  --member=serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com \  # ============================================================================

  --role=roles/container.developer  # Step 13: Update Frontend Deployment

```  # ============================================================================

  - name: 'gcr.io/cloud-builders/kubectl'

### Build falla en "get-credentials"    id: 'deploy-frontend'

- Verifica que el nombre del cluster sea correcto: `solar-facades-cluster`    args:

- Verifica la regiÃ³n: `us-central1`      - 'set'

      - 'image'

### Frontend no se conecta al backend despuÃ©s del despliegue      - 'deployment/frontend'

- Verifica que `VITE_API_URL` en `cloudbuild.yaml` tenga la IP correcta      - 'frontend=${_ARTIFACT_REGISTRY}/frontend:${SHORT_SHA}'

- Rebuild manual: `docker build --build-arg VITE_API_URL=http://34.135.241.88:8000 ...`      - '-n'

      - '${_NAMESPACE}'

## âœ… Checklist de ConfiguraciÃ³n    env:

      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'

- [ ] Cloud Build API habilitada      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'

- [ ] Permisos de Cloud Build configurados    waitFor: ['push-frontend', 'get-credentials']

- [ ] Repositorio GitHub conectado a Cloud Build

- [ ] Trigger creado y configurado  # ============================================================================

- [ ] IP del backend actualizada en `cloudbuild.yaml`  # Step 14: Wait for Backend Rollout

- [ ] Primer despliegue de prueba exitoso  # ============================================================================  # ============================================================================

  # Step 9: Update Ingestor Deployment

---  # ============================================================================

  - name: 'gcr.io/cloud-builders/kubectl'

**PrÃ³ximo Paso:** Conecta tu repositorio GitHub en la consola de Cloud Build y crea el trigger.    id: 'deploy-ingestor'

    args:

**Link directo:** https://console.cloud.google.com/cloud-build/triggers?project=bicpv-477720      - 'set'

      - 'image'
      - 'deployment/ingestor'
      - 'ingestor=${_ARTIFACT_REGISTRY}/ingestor:${SHORT_SHA}'
      - '-n'
      - '${_NAMESPACE}'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['push-ingestor', 'get-credentials']

  # ============================================================================
  # Step 10: Update Alert Monitor Deployment
  # ============================================================================
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'deploy-alert-monitor'
    args:
      - 'set'
      - 'image'
      - 'deployment/alert-monitor'
      - 'alert-monitor=${_ARTIFACT_REGISTRY}/alert-monitor:${SHORT_SHA}'
      - '-n'
      - '${_NAMESPACE}'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['push-alert-monitor', 'get-credentials']

  # ============================================================================
  # Step 14: Wait for Backend Rollout
  # ============================================================================
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'rollout-backend'
    args:
      - 'rollout'
      - 'status'
      - 'deployment/backend'
      - '-n'
      - '${_NAMESPACE}'
      - '--timeout=5m'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['deploy-backend']

  # ============================================================================
  # Step 15: Wait for Ingestor Rollout
  # ============================================================================
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'rollout-ingestor'
    args:
      - 'rollout'
      - 'status'
      - 'deployment/ingestor'
      - '-n'
      - '${_NAMESPACE}'
      - '--timeout=5m'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['deploy-ingestor']

  # ============================================================================
  # Step 16: Wait for Alert Monitor Rollout
  # ============================================================================
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'rollout-alert-monitor'
    args:
      - 'rollout'
      - 'status'
      - 'deployment/alert-monitor'
      - '-n'
      - '${_NAMESPACE}'
      - '--timeout=5m'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['deploy-alert-monitor']

  # ============================================================================
  # Step 17: Wait for Frontend Rollout
  # ============================================================================
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'rollout-frontend'
    args:
      - 'rollout'
      - 'status'
      - 'deployment/frontend'
      - '-n'
      - '${_NAMESPACE}'
      - '--timeout=5m'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['deploy-frontend']

  # ============================================================================
  # Step 18: Verify Deployment
  # ============================================================================
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'verify-deployment'
    args:
      - 'get'
      - 'pods'
      - '-n'
      - '${_NAMESPACE}'
      - '-o'
      - 'wide'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    waitFor: ['rollout-backend', 'rollout-ingestor', 'rollout-alert-monitor', 'rollout-frontend']

# ============================================================================
# Images to be stored in Artifact Registry
# ============================================================================
images:
  - '${_ARTIFACT_REGISTRY}/backend:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/backend:latest'
  - '${_ARTIFACT_REGISTRY}/ingestor:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/ingestor:latest'
  - '${_ARTIFACT_REGISTRY}/alert-monitor:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/alert-monitor:latest'
  - '${_ARTIFACT_REGISTRY}/frontend:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/frontend:latest'

# ============================================================================
# Timeout Configuration
# ============================================================================
timeout: '1800s'
